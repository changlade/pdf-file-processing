<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Document Explorer - CAR References</title>
    
    <!-- PDF.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    
    <style>
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f8fafc;
            --tertiary-bg: #f1f5f9;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --accent-blue: #0f172a;
            --accent-blue-light: #334155;
            --accent-orange: #ea580c;
            --accent-orange-light: #fb923c;
            --success: #059669;
            --warning: #d97706;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--secondary-bg);
            height: 100vh;
            overflow: hidden;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .left-panel {
            min-width: 320px;
            width: 60%;
            background: var(--primary-bg);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-sm);
            height: 100vh; /* Fixed height to full viewport */
        }

        .resizer {
            width: 4px;
            background: var(--border-light);
            cursor: col-resize;
            position: relative;
            z-index: 10;
            transition: background-color 0.15s ease;
        }

        .resizer:hover {
            background: var(--accent-orange);
        }

        .resizer::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: var(--border-medium);
            border-radius: 1px;
        }

        .resizer:hover::after {
            background: white;
        }

        .right-panel {
            flex: 1;
            background: var(--tertiary-bg);
            display: flex;
            flex-direction: column;
            overflow: visible;
            min-width: 500px;
        }

        .panel-header {
            background: var(--accent-blue);
            color: white;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .header-icon {
            font-size: 20px;
            opacity: 0.9;
        }

        .header-stats {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 6px;
            font-weight: 400;
        }

        .filter-section {
            padding: 24px;
            background: var(--primary-bg);
            border-bottom: 1px solid var(--border-light);
        }

        .filter-input {
            width: 100%;
            padding: 12px 120px 12px 44px; /* Extra padding on right for toggle and text */
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            background: var(--primary-bg);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            position: relative;
            height: 48px; /* Fixed height for consistent centering */
            box-sizing: border-box;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }

        .filter-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 16px;
            pointer-events: none;
        }

        .filter-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--tertiary-bg);
            padding: 4px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        .mode-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .mode-btn.active {
            background: var(--primary-bg);
            color: var(--accent-blue);
            box-shadow: var(--shadow-sm);
        }

        .mode-btn:hover:not(.active) {
            background: var(--primary-bg);
            color: var(--text-primary);
        }

        .search-section {
            transition: opacity 0.2s ease;
        }

        .semantic-search-btn {
            width: 100%;
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: background-color 0.15s ease;
        }

        .semantic-search-btn:hover {
            background: var(--accent-orange-light);
        }

        .semantic-search-btn:disabled {
            background: var(--border-medium);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .semantic-status {
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 12px;
            padding: 8px;
            background: var(--tertiary-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
        }

        .inline-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            z-index: 10;
            height: 24px; /* Fixed height for consistent centering */
        }

        .toggle-label-inline {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
            user-select: none;
        }

        .toggle-switch-inline {
            cursor: pointer;
            user-select: none;
        }

        .toggle-input-inline {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-inline {
            position: relative;
            width: 40px;
            height: 20px;
            background: #ddd !important;
            border-radius: 20px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-medium);
            display: block;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .toggle-slider-inline:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .toggle-input-inline:checked + .toggle-slider-inline,
        .inline-toggle .toggle-input-inline:checked + .toggle-slider-inline {
            background: #005EB8 !important;
            background-color: #005EB8 !important;
            border-color: #005EB8 !important;
            box-shadow: inset 0 1px 3px rgba(0, 94, 184, 0.2) !important;
        }

        .toggle-input-inline:checked + .toggle-slider-inline:before {
            transform: translateX(20px);
            box-shadow: 0 2px 4px rgba(0, 94, 184, 0.4);
        }

        .toggle-switch-inline:hover .toggle-slider-inline {
            border-color: var(--primary-color);
        }

        .toggle-input-inline:checked + .toggle-slider-inline:hover,
        .inline-toggle .toggle-input-inline:checked + .toggle-slider-inline:hover {
            background: #0083d1 !important;
            background-color: #0083d1 !important;
        }

        /* Visual indicator when toggle is active - subtle input field highlight */
        .filter-container:has(.toggle-input-inline:checked) .filter-input {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px rgba(0, 94, 184, 0.15);
        }

        .section-filter {
            margin-top: 16px;
            padding: 12px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
        }

        .filter-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .filter-icon {
            font-size: 14px;
        }

        .filter-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-tag {
            padding: 6px 12px;
            background: #FFFFFF;
            border: 2px solid #E5E7EB;
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: #4B5563;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            user-select: none;
            font-weight: 500;
        }

        .filter-tag:hover {
            border-color: #005EB8;
            color: #005EB8;
            background: #F8FAFC;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 94, 184, 0.1);
        }

        .filter-tag.active {
            background: #005EB8 !important;
            border-color: #005EB8 !important;
            color: #FFFFFF !important;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(0, 94, 184, 0.4);
            transform: translateY(-1px);
        }

        .filter-tag.active:hover {
            background: #00ACED !important;
            border-color: #00ACED !important;
            color: #FFFFFF !important;
            box-shadow: 0 4px 12px rgba(0, 172, 237, 0.5);
        }

        .reference-count {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .reference-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--primary-bg);
            padding: 16px;
        }

        .reference-tag {
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-blue-light);
            color: white;
            padding: 6px 12px;
            margin: 2px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.15s ease, transform 0.1s ease;
            letter-spacing: 0.025em;
            min-width: fit-content;
            max-width: fit-content;
        }

        .ref-name {
            text-align: left;
            white-space: nowrap;
        }

        .ref-count {
            font-weight: 600;
            opacity: 0.9;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .reference-tag:hover {
            background: var(--accent-blue);
            transform: translateY(-1px);
        }

        .reference-tag.selected {
            background: var(--accent-orange);
            box-shadow: var(--shadow-sm);
        }

        .text-blocks {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--secondary-bg);
        }

        /* Hide text-blocks when chat is active */
        .left-panel.chat-active .text-blocks {
            display: none !important;
        }

        /* Make filter section smaller when chat is active */
        .left-panel.chat-active .filter-section {
            flex-shrink: 0;
        }

        /* Make chat section take full remaining space */
        .left-panel.chat-active #chatSection {
            flex: 1;
            display: flex !important;
            flex-direction: column;
            height: calc(100vh - 160px); /* Account for header and filter sections */
            overflow: hidden;
        }

        /* Ensure the left panel structure when chat is active */
        .left-panel.chat-active {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .text-block {
            background: var(--primary-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
            box-shadow: var(--shadow-sm);
        }

        .text-block:hover {
            border-color: var(--accent-orange-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .text-block.highlighted {
            border-color: var(--accent-orange);
            background: linear-gradient(to right, #fef3c7, var(--primary-bg));
            box-shadow: var(--shadow-lg);
        }

        .block-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            font-size: 12px;
            color: var(--text-muted);
            gap: 12px;
        }

        .page-number {
            background: var(--text-muted);
            color: white;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.025em;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .block-references {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex: 1;
            justify-content: flex-end;
            align-items: flex-start;
        }

        .block-ref-tag {
            background: var(--success);
            color: white;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.025em;
        }

        .block-text {
            line-height: 1.6;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 400;
        }

        .block-summary-main {
            line-height: 1.6;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 400;
            margin: 12px 0;
            padding: 0;
        }

        .block-content-excerpt {
            background: var(--tertiary-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 10px;
            margin-top: 12px;
            font-size: 12px;
            line-height: 1.4;
            color: var(--text-muted);
            border-left: 3px solid var(--border-medium);
        }

        .block-content-excerpt strong {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* PDF Viewer Styles */
        .pdf-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #2d3748;
            min-height: 0; /* Allow flex item to shrink below content size */
        }

        .pdf-toolbar {
            background: var(--primary-bg);
            border-bottom: 1px solid var(--border-light);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-sm);
        }

        .pdf-toolbar button {
            background: var(--accent-blue-light);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.15s ease;
        }

        .pdf-toolbar button:hover {
            background: var(--accent-blue);
        }

        .pdf-toolbar button:disabled {
            background: var(--border-medium);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pdf-toolbar input {
            padding: 6px 10px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            width: 70px;
            text-align: center;
            font-size: 13px;
            background: var(--primary-bg);
        }

        .pdf-toolbar select {
            padding: 6px 10px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 13px;
            background: var(--primary-bg);
            color: var(--text-primary);
        }

        .toolbar-label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .pdf-viewer-container {
            flex: 1;
            overflow: auto;
            background: #2d3748;
            position: relative;
            /* Enable smooth scrolling */
            scroll-behavior: smooth;
            /* Add custom scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: var(--border-medium) var(--tertiary-bg);
        }

        /* Custom scrollbar for webkit browsers */
        .pdf-viewer-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .pdf-viewer-container::-webkit-scrollbar-track {
            background: var(--tertiary-bg);
            border-radius: 4px;
        }

        .pdf-viewer-container::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .pdf-viewer-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }

        #pdf-viewer {
            width: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            /* Allow content to expand beyond viewport height */
            box-sizing: border-box;
            /* Ensure the viewer can grow with its content */
            flex-shrink: 0;
        }

        .pdf-page-canvas {
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            background: white;
            position: relative;
            border-radius: var(--radius-sm);
        }

        /* PDF.js text layer styling for proper text selection */
        .textLayer {
            opacity: 0.1; /* Reduced opacity for better text visibility while maintaining selection */
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            font-family: 'Times New Roman', 'Times', serif; /* Better font for legal documents */
            font-size: inherit;
            line-height: 1.2;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .textLayer span {
            cursor: text;
            transform-origin: 0% 0%; /* avoids scaling glitches */
            white-space: pre;
        }

        .textLayer ::selection {
            background: rgba(0, 0, 255, 0.3); /* Blue highlight */
        }

        .textLayer ::-moz-selection {
            background: rgba(0, 0, 255, 0.3);
        }

        /* Also target our custom text-layer class for compatibility */
        .text-layer {
            opacity: 0.2;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .text-layer span {
            cursor: text;
            transform-origin: 0% 0%;
            white-space: pre;
        }

        .text-layer ::selection {
            background: rgba(0, 0, 255, 0.3);
        }

        .text-layer ::-moz-selection {
            background: rgba(0, 0, 255, 0.3);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--accent-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
            font-style: italic;
            background: var(--primary-bg);
            border-radius: var(--radius-md);
            margin: 16px;
            border: 1px solid var(--border-light);
        }

        .search-highlight {
            background: var(--warning);
            color: white;
            padding: 2px 4px;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--tertiary-bg);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Focus styles */
        .filter-input:focus,
        .pdf-toolbar input:focus,
        .pdf-toolbar select:focus,
        .pdf-toolbar button:focus {
            outline: 2px solid var(--accent-orange);
            outline-offset: 2px;
        }

        /* Chat Styles */
        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            margin-bottom: 0; /* Remove margin to allow input to be fixed */
            min-height: 0; /* Allow shrinking */
            height: 0; /* Force flex to calculate height */
        }

        /* When chat is active, ensure messages fill most of the space */
        .left-panel.chat-active .chat-messages {
            flex: 1;
            height: auto;
            max-height: calc(100vh - 320px); /* Account for header, filter, and input */
        }

        /* Fixed chat input at bottom */
        .chat-input-section {
            position: sticky;
            bottom: 0;
            background: var(--primary-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin: 16px 0 20px 0; /* Add bottom margin to ensure visibility */
            z-index: 10;
            flex-shrink: 0; /* Don't shrink the input area */
        }

        /* Make chat section fill available space when active */
        #chatSection {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden; /* Prevent overflow */
        }

        #chatSection .chat-container {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .welcome-message {
            margin-bottom: 16px;
        }

        .bot-message, .user-message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            line-height: 1.5;
            font-size: 14px;
        }

        .bot-message .message-content {
            background: var(--primary-bg);
            border: 1px solid var(--border-light);
            border-left: 4px solid #005EB8;
        }

        .user-message .message-content {
            background: #005EB8;
            color: white;
            border-left: 4px solid #00ACED;
        }

        /* Formatting styles for bot messages */
        .bot-message .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .bot-message .message-content li {
            margin: 4px 0;
            line-height: 1.5;
        }

        .bot-message .message-content strong {
            font-weight: 600;
            color: #005EB8;
        }

        .bot-message .message-content em {
            font-style: italic;
            color: var(--text-secondary);
        }

        .message-sources {
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--tertiary-bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid #54AD18;
        }

        .source-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 6px;
        }

        .source-item {
            font-size: 12px;
            color: #005EB8;
            margin-bottom: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
            text-decoration: underline;
            text-decoration-color: transparent;
        }

        .source-item:hover {
            background: #005EB8;
            color: white;
            transform: translateX(4px);
            text-decoration-color: white;
        }

        .source-item:last-child {
            margin-bottom: 0;
        }

        .sources-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .sources-toggle-btn {
            background: transparent;
            border: 1px solid var(--border-medium);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            font-weight: 500;
        }

        .sources-toggle-btn:hover {
            background: #005EB8;
            color: white;
            border-color: #005EB8;
        }

        .sources-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Clickable source references within answer text */
        .clickable-source {
            color: #005EB8;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: all 0.15s ease;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .clickable-source:hover {
            background: #005EB8;
            color: white;
            text-decoration-color: white;
        }


        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.5;
            background: var(--primary-bg);
            resize: none;
            min-height: 48px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #005EB8;
            box-shadow: 0 0 0 3px rgba(0, 94, 184, 0.1);
        }

        .send-chat-btn {
            background: #005EB8;
            color: white;
            border: none;
            border-radius: var(--radius-md);
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.15s ease;
            flex-shrink: 0;
        }

        .send-chat-btn:hover {
            background: #00ACED;
        }

        .send-chat-btn:disabled {
            background: var(--border-medium);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .send-icon {
            font-size: 16px;
            font-weight: bold;
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .clear-chat-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .clear-chat-btn:hover {
            background: #EF3340;
            color: white;
            border-color: #EF3340;
        }


        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--tertiary-bg);
            border-radius: var(--radius-md);
            border-left: 4px solid #005EB8;
            margin-bottom: 16px;
            font-style: italic;
            color: var(--text-secondary);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #005EB8;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            30% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Error message styles */
        .error-message {
            background: #FFB2BE !important;
            color: #EF3340 !important;
            border-left: 4px solid #EF3340 !important;
        }

        /* Sample questions styles */
        .sample-questions {
            margin-top: 16px;
            padding: 16px;
            background: var(--tertiary-bg);
            border-radius: var(--radius-md);
            border-left: 4px solid #005EB8;
        }

        .sample-questions-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 12px;
        }

        .sample-question-item {
            display: block;
            width: 100%;
            background: var(--primary-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            line-height: 1.4;
        }

        .sample-question-item:hover {
            background: #005EB8;
            color: white;
            border-color: #005EB8;
            transform: translateX(4px);
        }

        .sample-question-item:last-child {
            margin-bottom: 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                max-height: none;
                height: 100vh;
            }
            
            /* Hide PDF viewer on mobile - only show chatbot */
            .right-panel {
                display: none !important;
            }
            
            .resizer {
                display: none !important;
            }
            
            /* Hide navigation mode buttons on mobile - only show chat */
            .search-mode-toggle {
                display: none !important;
            }
            
            /* Hide other search sections on mobile */
            #carSearchSection, #semanticSearchSection {
                display: none !important;
            }

            .chat-messages {
                min-height: 60vh;
                max-height: 70vh;
            }

            .message-content {
                max-width: 95%;
            }
            
            /* Ensure chat section is visible by default on mobile */
            #chatSection {
                display: block !important;
            }
            
            
            /* Auto-activate chat mode on mobile */
            #chatModeBtn {
                background: var(--primary-color) !important;
                color: white !important;
            }
            
            #carModeBtn, #semanticModeBtn {
                background: var(--secondary-bg) !important;
                color: var(--text-color) !important;
            }
            
            /* Hide other search sections on mobile */
            #carSearchSection, #semanticSearchSection {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Reference Browser -->
        <div class="left-panel">
            <div class="panel-header">
                <div class="header-title">
                    <span class="header-icon">📄</span>
                    <span id="headerTitle">CAR References Explorer</span>
                </div>
                <div class="header-stats" id="headerStats">
                    Loading document references...
                </div>
            </div>
            
            <div class="filter-section">
                <!-- Search Mode Toggle -->
                <div class="search-mode-toggle">
                    <button id="carModeBtn" class="mode-btn active">CAR References</button>
                    <button id="semanticModeBtn" class="mode-btn">Semantic Search</button>
                    <button id="chatModeBtn" class="mode-btn">AI Chat</button>
                </div>

                <!-- CAR Search Section -->
                <div id="carSearchSection" class="search-section">
                <div class="filter-container">
                    <span class="search-icon">🔍</span>
                <input type="text" id="searchInput" class="filter-input" 
                           placeholder="Search CAR references (e.g., CAR-D29, CAR-OTP, CAR-V45)...">
                </div>
                
                <div class="reference-count" id="referenceCount">
                    Loading references...
                </div>
                
                <div class="reference-list" id="referenceList">
                    <!-- Reference tags will be populated here -->
                    </div>
                </div>

                <!-- Semantic Search Section -->
                <div id="semanticSearchSection" class="search-section" style="display: none;">
                    <div class="filter-container">
                        <span class="search-icon">🧠</span>
                        <input type="text" id="semanticInput" class="filter-input" 
                               placeholder="Enter semantic search query (e.g., 'violence against Muslims', 'war crimes evidence')...">
                        <div class="inline-toggle">
                            <span class="toggle-label-inline">Max results</span>
                            <label class="toggle-switch-inline" title="Get All References (500 results vs 20)">
                                <input type="checkbox" id="getAllToggle" class="toggle-input-inline">
                                <span class="toggle-slider-inline"></span>
                            </label>
                        </div>
                    </div>
                    <button id="semanticSearchBtn" class="semantic-search-btn">Search</button>
                    
                    <div class="section-filter" id="sectionFilter" style="display: none;">
                        <div class="filter-header">
                            <span class="filter-icon">🏷️</span>
                            <span class="filter-title">Filter by Section Type:</span>
                        </div>
                        <div class="filter-options">
                            <button class="filter-tag active" data-section="ALL">All</button>
                            <button class="filter-tag" data-section="VERDICT">Verdict</button>
                            <button class="filter-tag" data-section="SENTENCE">Sentence</button>
                            <button class="filter-tag" data-section="FINDINGS_OF_FACT">Findings of Fact</button>
                            <button class="filter-tag" data-section="OVERVIEW">Overview</button>
                            <button class="filter-tag" data-section="EVIDENTIARY_CONSIDERATIONS">Evidentiary Considerations</button>
                            <button class="filter-tag" data-section="HEADER">Header</button>
                        </div>
                    </div>
                    
                    <div class="semantic-status" id="semanticStatus" style="display: none;">
                        Searching...
                    </div>
                </div>

                <!-- AI Chat Section -->
                <div id="chatSection" class="search-section" style="display: none;">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="welcome-message">
                                <div class="bot-message">
                                    <div class="message-content">
                                        <strong>🤖 AI Assistant</strong><br>
                                        Hello! I'm your AI assistant. I can help you explore the ICC judgment document and answer questions about it. What would you like to know?
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-section">
                            <div class="chat-input-container">
                                <textarea id="chatInput" class="chat-input" 
                                         placeholder="Ask me anything about the ICC judgment..." 
                                         rows="2"></textarea>
                                <button id="sendChatBtn" class="send-chat-btn">
                                    <span class="send-icon">➤</span>
                                </button>
                            </div>
                            <div class="chat-controls">
                                <button id="clearChatBtn" class="clear-chat-btn">Clear Conversation</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-blocks" id="textBlocks">
                <div class="loading">Loading text blocks</div>
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Right Panel: PDF Viewer -->
        <div class="right-panel">
            <div class="panel-header">
                <div class="header-title">
                    <span class="header-icon">📖</span>
                    PDF Document: <span id="documentTitle">Jugement ICC</span>
                </div>
                <div class="header-stats" id="pdfStats">
                    Loading PDF...
                </div>
            </div>
            
            <div class="pdf-container">
                <div class="pdf-toolbar">
                    <button id="prev-page">◀ Previous</button>
                    <button id="next-page">Next ▶</button>
                    <span class="toolbar-label">Page: 
                        <input type="number" id="page-num" value="1" min="1">
                        of <span id="page-count">-</span>
                    </span>
                    <button id="zoom-out">Zoom Out</button>
                    <select id="zoom-select">
                        <option value="0.5">50%</option>
                        <option value="0.75">75%</option>
                        <option value="1.0">100%</option>
                        <option value="1.25" selected>125%</option>
                        <option value="1.5">150%</option>
                        <option value="2.0">200%</option>
                        <option value="auto">Auto Fit</option>
                        <option value="page-width">Fit Width</option>
                    </select>
                    <button id="zoom-in">Zoom In</button>
                </div>
                
                <div class="pdf-viewer-container">
                    <div id="pdf-viewer">
                        <div class="loading">Loading PDF viewer</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // Global variables
        let referencesData = null;
        let pdfData = null;
        let pdfDoc = null;
        let currentFilter = '';
        let selectedReference = null;
        let highlightedBlockId = null;
        let isResizing = false;
        let currentPage = 1;
        let totalPages = 0;
        let currentZoom = 1.25;
        
        // Semantic search variables
        let currentSearchMode = 'car'; // 'car', 'semantic', or 'chat'
        let semanticResults = null;
        let lastSemanticQuery = '';
        
        // Chat variables
        let chatHistory = [];
        let conversationId = generateConversationId();
        let isChatLoading = false;

        // PDF.js will be configured when loading the PDF

        // Function to detect mobile devices
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }


        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            setupResizer();
            setupPDFControls();

            // Ping endpoints to warm them up
            pingDatabricksEndpoints();

            // Auto-switch to chat mode on mobile devices
            if (isMobileDevice()) {
                switchSearchMode('chat');
            }
        });

        // Handle window resize for mobile/desktop switching
        window.addEventListener('resize', function() {
            if (isMobileDevice() && currentSearchMode !== 'chat') {
                switchSearchMode('chat');
            }
        });

        function setupEventListeners() {
            // CAR search input
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                if (currentSearchMode === 'car') {
                currentFilter = this.value.toLowerCase();
                filterReferences();
                updateTextBlocks();
                }
            });

            // Mode toggle buttons
            const carModeBtn = document.getElementById('carModeBtn');
            const semanticModeBtn = document.getElementById('semanticModeBtn');
            const chatModeBtn = document.getElementById('chatModeBtn');
            
            carModeBtn.addEventListener('click', () => switchSearchMode('car'));
            semanticModeBtn.addEventListener('click', () => switchSearchMode('semantic'));
            chatModeBtn.addEventListener('click', () => switchSearchMode('chat'));

            // Semantic search
            const semanticInput = document.getElementById('semanticInput');
            const semanticSearchBtn = document.getElementById('semanticSearchBtn');
            
            semanticSearchBtn.addEventListener('click', performSemanticSearch);
            
            semanticInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSemanticSearch();
                }
            });
            
            // Handle toggle change to automatically re-run last search
            const getAllToggle = document.getElementById('getAllToggle');
            if (getAllToggle) {
                getAllToggle.addEventListener('change', function() {
                    // If we have a previous query, automatically re-run it with the new setting
                    if (lastSemanticQuery) {
                        console.log(`🔄 Toggle changed, re-running search: "${lastSemanticQuery}" with get_all=${this.checked}`);
                        performSemanticSearch();
                    }
                });
            }

            // Handle section filter clicks
            const sectionFilter = document.getElementById('sectionFilter');
            if (sectionFilter) {
                sectionFilter.addEventListener('click', function(e) {
                    if (e.target.classList.contains('filter-tag')) {
                        const selectedSection = e.target.getAttribute('data-section');
                        
                        // Handle "All" button specially - it deselects everything else
                        if (selectedSection === 'ALL') {
                            sectionFilter.querySelectorAll('.filter-tag').forEach(tag => {
                                tag.classList.remove('active');
                            });
                            e.target.classList.add('active');
                        } else {
                            // Remove "All" if it's active and we're selecting a specific section
                            const allButton = sectionFilter.querySelector('.filter-tag[data-section="ALL"]');
                            if (allButton.classList.contains('active')) {
                                allButton.classList.remove('active');
                            }
                            
                            // Toggle the clicked section
                            e.target.classList.toggle('active');
                            
                            // If no sections are selected, activate "All"
                            const activeSections = sectionFilter.querySelectorAll('.filter-tag.active:not([data-section="ALL"])');
                            if (activeSections.length === 0) {
                                allButton.classList.add('active');
                            }
                        }
                        
                        // Get all selected sections and filter results
                        const selectedSections = getSelectedSections();
                        filterSemanticResults(selectedSections);
                    }
                });
            }

            // Chat functionality
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const clearChatBtn = document.getElementById('clearChatBtn');
            
            if (chatInput && sendChatBtn) {
                sendChatBtn.addEventListener('click', sendChatMessage);
                
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
                
                // Auto-resize textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
            
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', clearChatHistory);
            }
        }

        // Helper function to get selected sections
        function getSelectedSections() {
            const sectionFilter = document.getElementById('sectionFilter');
            const activeButtons = sectionFilter.querySelectorAll('.filter-tag.active');
            const selectedSections = [];
            
            activeButtons.forEach(button => {
                selectedSections.push(button.getAttribute('data-section'));
            });
            
            return selectedSections;
        }

        // Search Mode Functions
        function switchSearchMode(mode) {
            currentSearchMode = mode;
            
            const carModeBtn = document.getElementById('carModeBtn');
            const semanticModeBtn = document.getElementById('semanticModeBtn');
            const chatModeBtn = document.getElementById('chatModeBtn');
            const carSection = document.getElementById('carSearchSection');
            const semanticSection = document.getElementById('semanticSearchSection');
            const chatSection = document.getElementById('chatSection');
            const headerTitle = document.getElementById('headerTitle');
            const leftPanel = document.querySelector('.left-panel');
            
            // Reset all button states
            carModeBtn.classList.remove('active');
            semanticModeBtn.classList.remove('active');
            chatModeBtn.classList.remove('active');
            
            // Hide all sections
            carSection.style.display = 'none';
            semanticSection.style.display = 'none';
            chatSection.style.display = 'none';
            
            // Remove chat-active class from left panel
            leftPanel.classList.remove('chat-active');
            
            if (mode === 'car') {
                carModeBtn.classList.add('active');
                carSection.style.display = 'block';
                headerTitle.textContent = 'CAR References Explorer';
                
                // Show text blocks area
                document.getElementById('textBlocks').style.display = 'block';
                
                // Restore CAR search results
                updateTextBlocks();
            } else if (mode === 'semantic') {
                semanticModeBtn.classList.add('active');
                semanticSection.style.display = 'block';
                headerTitle.textContent = 'Semantic Search Explorer';
                
                // Show text blocks area
                document.getElementById('textBlocks').style.display = 'block';
                
                // Show semantic results if available
                if (semanticResults) {
                    displaySemanticResults();
                } else {
                    showSemanticWelcome();
                }
            } else if (mode === 'chat') {
                chatModeBtn.classList.add('active');
                chatSection.style.display = 'block';
                headerTitle.textContent = 'AI Chat Assistant';
                
                // Show chat interface
                showChatInterface();
            }
        }

        function showSemanticWelcome() {
            const textBlocksContainer = document.getElementById('textBlocks');
            const headerStats = document.getElementById('headerStats');
            
            // Clear header stats for semantic search welcome
            headerStats.textContent = '';
            
            textBlocksContainer.innerHTML = `
                <div class="no-results">
                    <h3 style="margin-bottom: 12px; color: var(--accent-blue);">🧠 Semantic Search</h3>
                    <p style="margin-bottom: 16px;">Search for concepts, topics, and meaning rather than exact text matches.</p>
                    <p style="font-size: 13px; color: var(--text-muted);">
                        Try queries like: "violence against Muslims", "war crimes evidence", "witness testimony about killings"
                    </p>
                </div>
            `;
        }

        async function performSemanticSearch() {
            const semanticInput = document.getElementById('semanticInput');
            const query = semanticInput.value.trim();
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            // Check if toggle state has changed to allow re-running same query with different settings
            const getAllToggle = document.getElementById('getAllToggle');
            const currentToggleState = getAllToggle ? getAllToggle.checked : false;
            
            if (query === lastSemanticQuery && semanticResults && window.lastToggleState === currentToggleState) {
                // Same query and same toggle state, just display existing results
                displaySemanticResults();
                return;
            }
            
            // Store current toggle state for comparison
            window.lastToggleState = currentToggleState;
            
            const statusDiv = document.getElementById('semanticStatus');
            const searchBtn = document.getElementById('semanticSearchBtn');
            const textBlocksContainer = document.getElementById('textBlocks');
            
            try {
                // Show loading state
                statusDiv.style.display = 'block';
                statusDiv.textContent = currentToggleState ? 'Searching with AI (getting all references)...' : 'Searching with AI...';
                searchBtn.disabled = true;
                textBlocksContainer.innerHTML = '<div class="loading">Performing semantic search...</div>';
                
                // Call Databricks API
                const results = await callDatabricksAPI(query);
                
                // Process and store results
                semanticResults = processSemanticResults(results);
                lastSemanticQuery = query;
                
                // Show result count for debugging and user feedback
                const getAllToggle = document.getElementById('getAllToggle');
                const isGetAll = getAllToggle && getAllToggle.checked;
                console.log(`📊 Received ${semanticResults.length} results (${isGetAll ? 'ALL mode (500)' : 'NORMAL mode (20)'})`);
                
                // Display results
                displaySemanticResults();
                
                statusDiv.style.display = 'none';
                
            } catch (error) {
                console.error('Semantic search error:', error);
                
                // Handle endpoint starting error with user-friendly message
                if (error.message === 'ENDPOINT_STARTING' || 
                    error.message.includes('Read timed out') || 
                    error.message.includes('HTTPSConnectionPool') ||
                    error.message.includes('dbc-0619d7f5-0bda.cloud.databricks.com')) {
                    
                    statusDiv.textContent = 'Search endpoint is starting up...';
                    statusDiv.style.color = '#f39c12';
                    
                    textBlocksContainer.innerHTML = `
                        <div class="no-results" style="color: #f39c12;">
                            🚀 The search endpoint is currently starting up. This usually takes about 30 seconds.
                            <br><br>
                            Please wait a moment and try your search again. The service will be ready shortly!
                        </div>
                    `;
                } else {
                    statusDiv.textContent = 'Search failed: ' + error.message;
                    statusDiv.style.color = '#e74c3c';
                    
                    textBlocksContainer.innerHTML = `
                        <div class="no-results" style="color: #e74c3c;">
                            ❌ Search failed: ${error.message}
                            <br><small>Check your connection and try again</small>
                        </div>
                    `;
                }
            } finally {
                searchBtn.disabled = false;
            }
        }

        async function callDatabricksAPI(query) {
            // Use local proxy server to avoid CORS issues
            const url = `${window.location.protocol}//${window.location.host}/semantic-search`;
            
            // Check if "Get all references" toggle is enabled
            const getAllToggle = document.getElementById('getAllToggle');
            const getAllReferences = getAllToggle && getAllToggle.checked;
            
            console.log('🔍 Semantic search debug:', {
                query: query,
                get_all: getAllReferences,
                toggle_found: !!getAllToggle,
                toggle_checked: getAllToggle ? getAllToggle.checked : 'N/A'
            });
            
            const requestData = {
                query: query,
                get_all: getAllReferences
            };
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                
                // Check if it's a 503 status (service unavailable) which indicates endpoint starting
                if (response.status === 503) {
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error === 'ENDPOINT_STARTING') {
                            throw new Error('ENDPOINT_STARTING');
                        }
                    } catch (parseError) {
                        // If we can't parse the error, fall through to generic error
                    }
                }
                
                throw new Error(`Proxy request failed: ${response.status} - ${errorText}`);
            }
            
            const result = await response.json();
            
            // Handle error responses from proxy
            if (result.error) {
                // Check for endpoint starting error
                if (result.error === 'ENDPOINT_STARTING') {
                    throw new Error('ENDPOINT_STARTING');
                }
                throw new Error(result.error);
            }
            
            return result;
        }

        function processSemanticResults(apiResult) {
            // Extract predictions from API response
            if (!apiResult || !apiResult.predictions || !Array.isArray(apiResult.predictions)) {
                throw new Error('Invalid API response format');
            }
            
            const predictions = apiResult.predictions[0]; // Get first (and only) prediction array
            
            if (!Array.isArray(predictions)) {
                throw new Error('No search results found');
            }
            
            // Process each result to match our display format
            let processedResults = predictions.map((result, index) => ({
                chunk_id: result.chunk_id || `result_${index}`,
                content: result.content || '',
                summary: result.summary || '',
                section_type: result.section_type || 'SEMANTIC_RESULT',
                page_range: result.page_range || 'Unknown',
                relevance_score: result.relevance_score || 0
            }));
            
            // Sort by relevance score (highest first)
            processedResults.sort((a, b) => b.relevance_score - a.relevance_score);
            
            return processedResults;
        }

        function displaySemanticResults() {
            const textBlocksContainer = document.getElementById('textBlocks');
            const headerStats = document.getElementById('headerStats');
            const sectionFilter = document.getElementById('sectionFilter');
            
            if (!semanticResults || semanticResults.length === 0) {
                textBlocksContainer.innerHTML = '<div class="no-results">No semantic search results found. Try a different query.</div>';
                headerStats.textContent = 'No results found';
                sectionFilter.style.display = 'none';
                return;
            }
            
            // Show section filter when we have results
            sectionFilter.style.display = 'block';
            
            // Reset filter to "All" and display all results
            const allFilter = sectionFilter.querySelector('[data-section="ALL"]');
            if (allFilter) {
                sectionFilter.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('active'));
                allFilter.classList.add('active');
            }
            
            // Clear header stats for semantic search mode
            headerStats.textContent = '';
            
            textBlocksContainer.innerHTML = '';
            
            semanticResults.forEach((result, index) => {
                const blockElement = createSemanticBlockElement(result, index);
                textBlocksContainer.appendChild(blockElement);
            });
        }

        function filterSemanticResults(selectedSections) {
            const textBlocksContainer = document.getElementById('textBlocks');
            
            if (!semanticResults || semanticResults.length === 0) {
                return;
            }
            
            // Filter results based on selected section types
            let filteredResults = semanticResults;
            
            // If "ALL" is selected or no sections are selected, show all results
            if (!selectedSections.includes('ALL') && selectedSections.length > 0) {
                filteredResults = semanticResults.filter(result => 
                    selectedSections.includes(result.section_type)
                );
            }
            
            // Clear and display filtered results
            textBlocksContainer.innerHTML = '';
            
            if (filteredResults.length === 0) {
                const sectionNames = selectedSections.join(', ');
                textBlocksContainer.innerHTML = `<div class="no-results">No results found for section types: ${sectionNames}</div>`;
                return;
            }
            
            filteredResults.forEach((result, index) => {
                const blockElement = createSemanticBlockElement(result, index);
                textBlocksContainer.appendChild(blockElement);
            });
            
            const sectionNames = selectedSections.includes('ALL') ? 'ALL' : selectedSections.join(', ');
            console.log(`🏷️ Filtered results: ${filteredResults.length} of ${semanticResults.length} for section types: ${sectionNames}`);
        }

        function createSemanticBlockElement(result, index) {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'text-block';
            blockDiv.dataset.blockId = result.chunk_id;
            blockDiv.onclick = () => highlightSemanticResult(result);
            
            if (highlightedBlockId === result.chunk_id) {
                blockDiv.classList.add('highlighted');
            }
            
            const blockInfo = document.createElement('div');
            blockInfo.className = 'block-info';
            
            // Display full page range (e.g., "1192-1192" or "1192-1194")
            const pageRange = result.page_range || 'Unknown';
            
            const pageElement = document.createElement('span');
            pageElement.className = 'page-number';
            
            // Format page range display
            if (pageRange === 'Unknown') {
                pageElement.textContent = 'Page Unknown';
            } else if (pageRange.includes('-')) {
                const [startPage, endPage] = pageRange.split('-');
                if (startPage === endPage) {
                    pageElement.textContent = `Page ${startPage}`;
                } else {
                    pageElement.textContent = `Pages ${startPage}-${endPage}`;
                }
            } else {
                pageElement.textContent = `Page ${pageRange}`;
            }
            
            const metadata = document.createElement('div');
            metadata.className = 'block-references';
            
            // Add relevance score (most important, so show first)
            if (result.relevance_score) {
                const scoreTag = document.createElement('span');
                scoreTag.className = 'block-ref-tag';
                scoreTag.style.background = '#54AD18'; // Danone green
                scoreTag.style.fontWeight = '600';
                scoreTag.textContent = calculateConfidenceLevel(result.relevance_score);
                metadata.appendChild(scoreTag);
            }
            
            // Add section type
            const sectionTag = document.createElement('span');
            sectionTag.className = 'block-ref-tag';
            sectionTag.style.background = '#005EB8'; // Danone primary blue
            sectionTag.textContent = result.section_type;
            metadata.appendChild(sectionTag);
            
            blockInfo.appendChild(pageElement);
            blockInfo.appendChild(metadata);
            
            blockDiv.appendChild(blockInfo);
            
            // Main content: Summary (primary display)
            if (result.summary && result.summary.trim()) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'block-summary-main';
                summaryDiv.textContent = result.summary;
                blockDiv.appendChild(summaryDiv);
            }
            
            // Secondary content: Raw content excerpt for reference
            const contentExcerpt = document.createElement('div');
            contentExcerpt.className = 'block-content-excerpt';
            
            // Show first ~200 characters of raw content for reference
            const excerptLength = 200;
            const excerpt = result.content.length > excerptLength 
                ? result.content.substring(0, excerptLength) + '...'
                : result.content;
            
            contentExcerpt.innerHTML = `<strong>Raw content:</strong> ${excerpt}`;
            blockDiv.appendChild(contentExcerpt);
            
            return blockDiv;
        }

        function extractPageFromRange(pageRange) {
            if (!pageRange || pageRange === 'Unknown') return 'Unknown';
            
            // Handle formats like "1192-1192" or "1192"
            const match = pageRange.match(/(\d+)/);
            return match ? match[1] : pageRange;
        }

        function highlightSemanticResult(result) {
            highlightedBlockId = result.chunk_id;
            
            // Update text block highlighting
            document.querySelectorAll('.text-block').forEach(el => {
                el.classList.remove('highlighted');
            });
            
            const currentBlock = document.querySelector(`[data-block-id="${result.chunk_id}"]`);
            if (currentBlock) {
                currentBlock.classList.add('highlighted');
            }
            
            // Navigate to the page in PDF - use first page of range
            const pageNumber = extractFirstPageFromRange(result.page_range);
            if (pageNumber !== 'Unknown') {
                navigateToPDFPage(parseInt(pageNumber), result);
            }
        }

        function extractFirstPageFromRange(pageRange) {
            if (!pageRange || pageRange === 'Unknown') return 'Unknown';
            
            // Handle formats like "1192-1194" -> "1192" or "1192" -> "1192"
            if (pageRange.includes('-')) {
                return pageRange.split('-')[0];
            }
            return pageRange;
        }

        function setupPDFControls() {
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage(currentPage);
                    updatePageNum();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage(currentPage);
                    updatePageNum();
                }
            });

            document.getElementById('page-num').addEventListener('change', function() {
                const pageNum = parseInt(this.value);
                if (pageNum >= 1 && pageNum <= totalPages) {
                    currentPage = pageNum;
                    renderPage(currentPage);
                } else {
                    this.value = currentPage;
                }
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                currentZoom = Math.max(0.25, currentZoom - 0.25);
                document.getElementById('zoom-select').value = currentZoom;
                renderPage(currentPage);
            });

            document.getElementById('zoom-in').addEventListener('click', () => {
                currentZoom = Math.min(3.0, currentZoom + 0.25);
                document.getElementById('zoom-select').value = currentZoom;
                renderPage(currentPage);
            });

            document.getElementById('zoom-select').addEventListener('change', function() {
                const value = this.value;
                if (value === 'auto' || value === 'page-width') {
                    // Handle auto-fit later
                    currentZoom = 1.0;
                } else {
                    currentZoom = parseFloat(value);
                }
                renderPage(currentPage);
            });
        }

        function setupResizer() {
            const resizer = document.getElementById('resizer');
            const leftPanel = document.querySelector('.left-panel');
            const container = document.querySelector('.container');

            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });

            function handleResize(e) {
                if (!isResizing) return;
                
                const containerRect = container.getBoundingClientRect();
                const newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                
                // Constrain between 30% and 80%
                const constrainedWidth = Math.max(30, Math.min(80, newWidth));
                leftPanel.style.width = constrainedWidth + '%';
            }

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        async function pingDatabricksEndpoints() {
            console.log('🚀 Pinging Databricks endpoints to warm them up...');

            try {
                const response = await fetch('/ping-endpoints', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('📡 Endpoint ping results:', result);

                if (result.semantic_search?.status === 'success') {
                    console.log('✅ Semantic search endpoint is ready');
                } else {
                    console.warn('⚠️ Semantic search endpoint ping failed:', result.semantic_search?.error);
                }

                if (result.rag_chat?.status === 'success') {
                    console.log('✅ RAG chat endpoint is ready');
                } else {
                    console.warn('⚠️ RAG chat endpoint ping failed:', result.rag_chat?.error);
                }

            } catch (error) {
                console.error('❌ Failed to ping endpoints:', error);
                console.log('   Endpoints may take longer to respond on first use');
            }
        }

        async function loadData() {
            try {
                // Load references data
                const referencesResponse = await fetch('../data/car_references.json');
                referencesData = await referencesResponse.json();
                
                console.log('Loaded references data:', {
                    references: referencesData.extraction_info.unique_references,
                    blocks: referencesData.extraction_info.total_reference_blocks
                });
                
                // Load PDF
                await loadPDF();
                
                // Initialize the interface
                initializeInterface();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data files. Make sure the data folder contains car_references.json and jugement.pdf');
            }
        }

        async function loadPDF() {
            try {
                // Set PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Always load PDF from the data folder via the Flask route
                const pdfUrl = '/data/jugement.pdf';
                console.log('Loading PDF from:', pdfUrl);
                
                pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
                totalPages = pdfDoc.numPages;
                
                document.getElementById('page-count').textContent = totalPages;
                
                // Render first page
                await renderPage(1);
                
                console.log('PDF loaded successfully:', {
                    pages: totalPages,
                    title: pdfDoc.title || 'Jugement ICC'
                });
                
            } catch (error) {
                console.error('Error loading PDF:', error);
                showError('Failed to load PDF file. Make sure jugement.pdf is in the data folder.');
            }
        }

        async function renderPage(pageNumber) {
            if (!pdfDoc) {
                console.error('PDF document not loaded');
                return;
            }
            
            try {
                console.log(`Rendering page ${pageNumber}...`);
                const page = await pdfDoc.getPage(pageNumber);
                
                // Calculate viewport with proper scaling
                let scale = currentZoom;
                const originalViewport = page.getViewport({ scale: 1.0 });
                
                // Auto-fit to container width if selected
                if (document.getElementById('zoom-select').value === 'page-width') {
                    const container = document.getElementById('pdf-viewer');
                    const containerWidth = container.clientWidth - 40; // Account for padding
                    scale = containerWidth / originalViewport.width;
                    currentZoom = scale;
                }
                
                const viewport = page.getViewport({ scale: scale });
                
                // Create canvas with high-DPI support
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                const context = canvas.getContext('2d');
                
                // Get device pixel ratio for high-DPI displays
                const devicePixelRatio = window.devicePixelRatio || 1;
                const qualityMultiplier = Math.max(1, devicePixelRatio);
                
                // Set canvas size for high-DPI rendering
                canvas.width = viewport.width * qualityMultiplier;
                canvas.height = viewport.height * qualityMultiplier;
                
                // Scale the canvas back down using CSS
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';
                
                // Scale the drawing context so everything draws at the higher resolution
                context.scale(qualityMultiplier, qualityMultiplier);
                
                // Enable high-quality image rendering
                context.imageSmoothingEnabled = true;
                context.imageSmoothingQuality = 'high';
                
                // Create text layer for text selection (using PDF.js standard class name)
                const textLayer = document.createElement('div');
                textLayer.className = 'textLayer';
                textLayer.style.position = 'absolute';
                textLayer.style.top = '0';
                textLayer.style.left = '0';
                textLayer.style.width = viewport.width + 'px';
                textLayer.style.height = viewport.height + 'px';
                textLayer.style.pointerEvents = 'auto'; // Enable text selection
                textLayer.style.cursor = 'text'; // Show text cursor
                textLayer.style.zIndex = '10'; // Ensure it's above the canvas
                
                // Wrapper for canvas and text layer
                const pageWrapper = document.createElement('div');
                pageWrapper.style.position = 'relative';
                pageWrapper.style.display = 'inline-block';
                pageWrapper.style.marginBottom = '20px';
                pageWrapper.appendChild(canvas);
                pageWrapper.appendChild(textLayer);
                
                // Clear viewer and add page
                const viewer = document.getElementById('pdf-viewer');
                viewer.innerHTML = '';
                viewer.appendChild(pageWrapper);
                
                // Show loading state
                viewer.style.background = '#525659';
                canvas.style.opacity = '0';
                
                // Render PDF page
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                await renderTask.promise;
                
                // Get text content for highlighting
                const textContent = await page.getTextContent();
                
                // Render text layer for text selection
                pdfjsLib.renderTextLayer({
                    textContentSource: textContent,
                    container: textLayer,
                    viewport: viewport,
                    textDivs: []
                });
                
                // Set the required CSS variable for text layer scaling
                // PDF.js expects this on the container element or higher up in the DOM
                viewer.style.setProperty('--scale-factor', viewport.scale);
                textLayer.style.setProperty('--scale-factor', viewport.scale);
                pageWrapper.style.setProperty('--scale-factor', viewport.scale);
                
                // Store page data for reference
                window.currentPageData = {
                    pageNumber: pageNumber,
                    textContent: textContent,
                    viewport: viewport,
                    textLayer: textLayer
                };
                
                // Show rendered page
                canvas.style.opacity = '1';
                canvas.style.transition = 'opacity 0.3s ease';
                
                // Update controls
                updatePageControls();
                
                console.log(`Successfully rendered page ${pageNumber} (${viewport.width}x${viewport.height} at ${(scale * 100).toFixed(0)}% zoom)`);
                
            } catch (error) {
                console.error('Error rendering page:', error);
                const viewer = document.getElementById('pdf-viewer');
                viewer.innerHTML = `<div class="loading" style="color: #e74c3c;">Error rendering page ${pageNumber}</div>`;
            }
        }

        function updatePageControls() {
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function updatePageNum() {
            document.getElementById('page-num').value = currentPage;
        }

        function initializeInterface() {
            updateHeaderStats();
            updateReferenceList();
            updateTextBlocks();
        }

        function updateHeaderStats() {
            const headerStats = document.getElementById('headerStats');
            const pdfStats = document.getElementById('pdfStats');
            
            if (referencesData && pdfDoc) {
                // Clear header stats for clean interface
                headerStats.textContent = '';
                pdfStats.textContent = ''; // Clear PDF stats
            }
        }


        function updateReferenceList() {
            const referenceList = document.getElementById('referenceList');
            const referenceCount = document.getElementById('referenceCount');
            
            if (!referencesData) return;
            
            // Filter for CAR references only
            const allReferences = Object.keys(referencesData.reference_index);
            const carReferences = allReferences.filter(ref => ref.startsWith('CAR-'));
            
            const filteredRefs = carReferences.filter(ref => 
                ref.toLowerCase().includes(currentFilter)
            );
            
            referenceCount.innerHTML = `<strong>${filteredRefs.length}</strong> CAR references found`;
            
            referenceList.innerHTML = '';
            
            // Sort references by occurrence count (most occurrences first)
            const sortedRefs = filteredRefs.sort((a, b) => {
                const countA = referencesData.reference_index[a].length;
                const countB = referencesData.reference_index[b].length;
                
                // Sort by count descending, then alphabetically
                if (countA !== countB) {
                    return countB - countA; // Descending order
                }
                return a.localeCompare(b);
            });
            
            sortedRefs.slice(0, 50).forEach(ref => { // Show only first 50 for performance
                const count = referencesData.reference_index[ref].length;
                const tag = document.createElement('button');
                tag.className = 'reference-tag';
                tag.onclick = () => selectReference(ref);
                
                // Create structured layout for reference and count
                const refSpan = document.createElement('span');
                refSpan.className = 'ref-name';
                refSpan.textContent = ref;
                
                const countSpan = document.createElement('span');
                countSpan.className = 'ref-count';
                countSpan.textContent = `(${count})`;
                
                tag.appendChild(refSpan);
                tag.appendChild(countSpan);
                
                if (selectedReference === ref) {
                    tag.classList.add('selected');
                }
                
                referenceList.appendChild(tag);
            });
            
            if (filteredRefs.length > 50) {
                const moreDiv = document.createElement('div');
                moreDiv.style.textAlign = 'center';
                moreDiv.style.marginTop = '10px';
                moreDiv.style.fontSize = '11px';
                moreDiv.style.color = '#666';
                moreDiv.textContent = `... and ${filteredRefs.length - 50} more references`;
                referenceList.appendChild(moreDiv);
            }
        }

        function selectReference(reference) {
            selectedReference = selectedReference === reference ? null : reference;
            updateReferenceList();
            updateTextBlocks();
        }

        function updateTextBlocks() {
            const textBlocksContainer = document.getElementById('textBlocks');
            
            if (!referencesData) return;
            
            let blocksToShow = referencesData.reference_blocks;
            
            // Filter by selected reference
            if (selectedReference) {
                blocksToShow = referencesData.reference_index[selectedReference] || [];
            } else if (currentFilter) {
                blocksToShow = blocksToShow.filter(block => 
                    block.text_block.toLowerCase().includes(currentFilter) ||
                    block.references.some(ref => 
                        ref.toLowerCase().includes(currentFilter) && ref.startsWith('CAR-')
                    )
                );
            } else {
                // Show only blocks with CAR references by default
                blocksToShow = blocksToShow.filter(block =>
                    block.references.some(ref => ref.startsWith('CAR-'))
                );
            }
            
            if (blocksToShow.length === 0) {
                textBlocksContainer.innerHTML = '<div class="no-results">No matching CAR reference blocks found. Try a different search term.</div>';
                return;
            }
            
            textBlocksContainer.innerHTML = '';
            
            // Sort blocks by page number and show first 100 for performance
            blocksToShow.sort((a, b) => a.page_number - b.page_number);
            const displayBlocks = blocksToShow.slice(0, 100);
            
            displayBlocks.forEach(block => {
                const blockElement = createTextBlockElement(block);
                textBlocksContainer.appendChild(blockElement);
            });
            
            if (blocksToShow.length > 100) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'no-results';
                moreDiv.textContent = `Showing first 100 of ${blocksToShow.length} blocks. Refine your search for more specific results.`;
                textBlocksContainer.appendChild(moreDiv);
            }
        }

        function createTextBlockElement(block) {
            const blockDiv = document.createElement('div');
            blockDiv.className = 'text-block';
            blockDiv.dataset.blockId = block.block_id;
            blockDiv.onclick = () => highlightInPDF(block);
            
            if (highlightedBlockId === block.block_id) {
                blockDiv.classList.add('highlighted');
            }
            
            const blockInfo = document.createElement('div');
            blockInfo.className = 'block-info';
            
            const pageNumber = document.createElement('span');
            pageNumber.className = 'page-number';
            pageNumber.textContent = `Page ${block.page_number}`;
            
            const references = document.createElement('div');
            references.className = 'block-references';
            
            // Show only CAR references in the tags
            const carRefs = block.references.filter(ref => ref.startsWith('CAR-'));
            carRefs.forEach(ref => {
                const refTag = document.createElement('span');
                refTag.className = 'block-ref-tag';
                refTag.textContent = ref;
                references.appendChild(refTag);
            });
            
            blockInfo.appendChild(pageNumber);
            blockInfo.appendChild(references);
            
            const blockText = document.createElement('div');
            blockText.className = 'block-text';
            
            // Highlight search terms in text
            let displayText = block.text_block;
            if (currentFilter) {
                const regex = new RegExp(`(${escapeRegex(currentFilter)})`, 'gi');
                displayText = displayText.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            blockText.innerHTML = displayText;
            
            blockDiv.appendChild(blockInfo);
            blockDiv.appendChild(blockText);
            
            return blockDiv;
        }

        function highlightInPDF(block) {
            highlightedBlockId = block.block_id;
            
            // Update text block highlighting
            document.querySelectorAll('.text-block').forEach(el => {
                el.classList.remove('highlighted');
            });
            
            const currentBlock = document.querySelector(`[data-block-id="${block.block_id}"]`);
            if (currentBlock) {
                currentBlock.classList.add('highlighted');
            }
            
            // Navigate to the page in PDF and pass the block object with its specific CAR references
            navigateToPDFPage(block.page_number, block);
        }

        async function navigateToPDFPage(pageNumber, blockData = null) {
            if (pageNumber !== currentPage) {
                currentPage = pageNumber;
                await renderPage(currentPage);
                updatePageNum();
            }
            
            // No highlighting - just navigate to the page
            console.log(`Navigated to page ${pageNumber} for block with references:`, 
                        blockData && blockData.references ? blockData.references.filter(ref => ref.startsWith('CAR-')) : []);
        }

        // Highlighting functions removed - PDF is now selectable but without highlights

        function extractCARReferencesFromText(text) {
            // Match CAR references in various formats including revision suffixes like -R01, -R02, etc.
            const carPatterns = [
                // CAR-OTP patterns with optional revision suffix
                /CAR-OTP-\d+-\d+(?:-R\d+)?/gi,
                // CAR-D## patterns with optional revision suffix  
                /CAR-D\d+-\d+-\d+(?:-R\d+)?/gi,
                // CAR-V## patterns with optional revision suffix
                /CAR-V\d+-\d+-\d+(?:-R\d+)?/gi,
                // General CAR patterns with optional revision suffix
                /CAR-[A-Z]+\d*-\d+-\d+(?:-R\d+)?/gi,
                // Additional patterns for edge cases
                /CAR-[A-Z]{2,}-\d+-\d+(?:-R\d+)?/gi
            ];
            
            const references = new Set();
            
            carPatterns.forEach(pattern => {
                const matches = text.match(pattern) || [];
                matches.forEach(match => {
                    // Clean up the match and add to set
                    const cleanMatch = match.trim().toUpperCase();
                    references.add(cleanMatch);
                });
            });
            
            console.log(`Extracted ${references.size} CAR references from text:`, Array.from(references));
            
            return Array.from(references);
        }

        // Text positioning function removed - no longer needed for highlighting

        // Highlight overlay function removed - no longer needed

        function filterReferences() {
            updateReferenceList();
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            document.getElementById('textBlocks').innerHTML = `<div class="no-results">❌ ${message}</div>`;
            document.getElementById('pdf-viewer').innerHTML = `<div class="no-results">❌ ${message}</div>`;
        }

        // Chat Functions
        function generateConversationId() {
            return 'session_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
        }

        function showChatInterface() {
            const textBlocksContainer = document.getElementById('textBlocks');
            const headerStats = document.getElementById('headerStats');
            const leftPanel = document.querySelector('.left-panel');
            
            // Clear header stats for chat mode
            headerStats.textContent = '';
            
            // Add chat-active class to left panel for CSS targeting
            leftPanel.classList.add('chat-active');
            
            // Add sample questions to chat if it's empty (only welcome message)
            addSampleQuestions();
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message || isChatLoading) {
                return;
            }
            
            // Clear input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Remove sample questions if they exist (conversation is starting)
            const sampleQuestions = document.getElementById('chatMessages').querySelector('.sample-questions');
            if (sampleQuestions) {
                sampleQuestions.remove();
            }
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                isChatLoading = true;
                
                // Call RAG endpoint
                const response = await callRAGEndpoint(message);
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Add bot response to chat
                addMessageToChat('bot', response.response, response.sources);
                
                // Store conversation
                chatHistory.push({
                    user: message,
                    bot: response.response,
                    sources: response.sources,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator();
                
                let errorMessage = error.message;
                
                // Handle endpoint starting error with user-friendly message
                if (error.message === 'ENDPOINT_STARTING' || 
                    error.message.includes('Read timed out') || 
                    error.message.includes('HTTPSConnectionPool') ||
                    error.message.includes('dbc-0619d7f5-0bda.cloud.databricks.com')) {
                    errorMessage = `🚀 The AI endpoint is currently starting up. This usually takes about 30 seconds.
                    
Please wait a moment and try your question again. The service will be ready shortly!`;
                    
                    // Add a retry button or suggestion
                    addMessageToChat('bot', errorMessage, null, false);
                    return; // Don't mark as error since this is expected behavior
                }
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = `Unable to connect to the AI service. Please make sure:
                    1. The proxy server is running on port 8002
                    2. Your Databricks token is properly configured
                    3. You have internet connection
                    
                    Technical error: ${error.message}`;
                }
                
                addMessageToChat('bot', errorMessage, null, true);
            } finally {
                isChatLoading = false;
            }
        }

        async function callRAGEndpoint(query) {
            // Use the local proxy to avoid CORS issues
            const proxyUrl = `${window.location.protocol}//${window.location.host}/rag-chat`;
            
            const requestData = {
                query: [query],
                num_results: [10],
                conversation_id: [conversationId]
            };
            
            console.log('🔄 Calling RAG endpoint via proxy:', {
                url: proxyUrl,
                query: query,
                conversation_id: conversationId
            });
            
            const response = await fetch(proxyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ Proxy error:', response.status, errorText);
                
                // Check if it's a 503 status (service unavailable) which indicates endpoint starting
                if (response.status === 503) {
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error === 'ENDPOINT_STARTING') {
                            throw new Error('ENDPOINT_STARTING');
                        }
                    } catch (parseError) {
                        // If we can't parse the error, fall through to generic error
                    }
                }
                
                throw new Error(`RAG proxy error: ${response.status} - ${errorText}`);
            }
            
            const result = await response.json();
            console.log('✅ RAG response received:', result);
            
            // Handle error responses from proxy
            if (result.error) {
                // Check for endpoint starting error
                if (result.error === 'ENDPOINT_STARTING') {
                    throw new Error('ENDPOINT_STARTING');
                }
                throw new Error(result.error);
            }
            
            // Handle Databricks response format with predictions array
            if (result && result.predictions && Array.isArray(result.predictions)) {
                // The predictions array contains response objects directly
                if (result.predictions.length > 0) {
                    const firstPrediction = result.predictions[0];
                    
                    // Check if it's a response object with the expected structure
                    if (firstPrediction && firstPrediction.response) {
                        console.log('📝 Successfully extracted RAG response:', {
                            response_length: firstPrediction.response.length,
                            sources_count: firstPrediction.sources ? firstPrediction.sources.length : 0,
                            conversation_id: firstPrediction.conversation_id
                        });
                        return firstPrediction;
                    }
                }
            }
            
            // Handle direct array response
            if (result && Array.isArray(result) && result.length > 0) {
                return result[0];
            } 
            
            // Handle direct response format
            if (result && result.response) {
                return result;
            }
            
            console.error('❌ Unexpected response format:', result);
            throw new Error('Invalid response format from RAG endpoint');
        }

        function getDatabricksToken() {
            // Try to get token from window global or use a placeholder
            return window.DATABRICKS_TOKEN || 'your-databricks-token-here';
        }

        function calculateConfidenceLevel(score) {
            // Multiply by 10000 to get the correct relevance score
            const correctedScore = score * 10000;
            
            if (correctedScore > 60) {
                return 'Very high confidence';
            } else if (correctedScore >= 40) {
                return 'High confidence';
            } else {
                return 'Low confidence';
            }
        }

        function makeSourceReferencesClickable(content, sources) {
            // Create a map of source information for quick lookup
            const sourceMap = new Map();
            sources.forEach((source, index) => {
                if (source.pages) {
                    const pageMatch = source.pages.match(/(\d+)/);
                    if (pageMatch) {
                        const pageNumber = parseInt(pageMatch[1]);
                        const sectionText = source.section || 'Document';
                        sourceMap.set(sectionText.toLowerCase(), pageNumber);
                        sourceMap.set(`page ${source.pages}`, pageNumber);
                        sourceMap.set(`pages ${source.pages}`, pageNumber);
                    }
                }
            });
            
            // Pattern to match source references in text
            // Look for patterns like "According to [Source Name]" or "page 1234" or "pages 1234-1235"
            let processedContent = content;
            
            // Match page references like "page 1234" or "pages 1234-1235"
            processedContent = processedContent.replace(/\b(pages?\s+\d+(?:-\d+)?)\b/gi, (match) => {
                const pageMatch = match.match(/(\d+)/);
                if (pageMatch) {
                    const pageNumber = parseInt(pageMatch[1]);
                    return `<span class="clickable-source" data-page="${pageNumber}" title="Click to navigate to ${match}">${match}</span>`;
                }
                return match;
            });
            
            // Match section references that exist in our sources
            sourceMap.forEach((pageNumber, sectionKey) => {
                if (sectionKey.includes('page')) return; // Skip page entries, already handled above
                
                // Create regex for section names (case insensitive)
                const sectionRegex = new RegExp(`\\b(${sectionKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})\\b`, 'gi');
                processedContent = processedContent.replace(sectionRegex, (match) => {
                    return `<span class="clickable-source" data-page="${pageNumber}" title="Click to navigate to ${match}">${match}</span>`;
                });
            });
            
            return processedContent;
        }

        function addMessageToChat(sender, content, sources = null, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'user-message' : 'bot-message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (isError) {
                messageContent.className += ' error-message';
            }
            
            if (sender === 'user') {
                messageContent.textContent = content;
            } else {
                // Convert markdown-like formatting to HTML
                let formattedContent = content
                    // Convert bullet points (*, -, +) to HTML lists
                    .replace(/^\s*[\*\-\+]\s+(.+)$/gm, '<li>$1</li>')
                    // Convert bold text (**text** or __text__)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/__(.*?)__/g, '<strong>$1</strong>')
                    // Convert italic text (*text* or _text_)
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/_([^_]+)_/g, '<em>$1</em>')
                    // Convert line breaks
                    .replace(/\n/g, '<br>');
                
                // Wrap consecutive list items in <ul> tags
                formattedContent = formattedContent.replace(/(<li>.*?<\/li>)(?:\s*<br>\s*<li>.*?<\/li>)*/g, function(match) {
                    // Remove <br> tags between list items and wrap in <ul>
                    const cleanedMatch = match.replace(/<br>\s*/g, '');
                    return '<ul>' + cleanedMatch + '</ul>';
                });
                
                // Make source references in text clickable
                if (sources && sources.length > 0) {
                    formattedContent = makeSourceReferencesClickable(formattedContent, sources);
                }
                
                messageContent.innerHTML = formattedContent;
                
                // Add click event listeners to clickable sources in the text
                const clickableSources = messageContent.querySelectorAll('.clickable-source');
                clickableSources.forEach(sourceElement => {
                    sourceElement.addEventListener('click', () => {
                        const pageNumber = parseInt(sourceElement.getAttribute('data-page'));
                        if (pageNumber) {
                            console.log(`🔗 Navigating to page ${pageNumber} from inline source: ${sourceElement.textContent}`);
                            navigateToPDFPage(pageNumber);
                        }
                    });
                });
                
                // Add sources if available
                if (sources && sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'message-sources';
                    
                    const sourcesHeader = document.createElement('div');
                    sourcesHeader.className = 'sources-header';
                    
                    const sourcesTitle = document.createElement('div');
                    sourcesTitle.className = 'source-title';
                    sourcesTitle.textContent = `Sources (${sources.length}):`;
                    sourcesHeader.appendChild(sourcesTitle);
                    
                    // Add collapse/expand button for large source lists
                    const maxVisibleSources = 3;
                    const hasManySources = sources.length > maxVisibleSources;
                    
                    if (hasManySources) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'sources-toggle-btn';
                        toggleBtn.textContent = 'Show all';
                        toggleBtn.type = 'button';
                        sourcesHeader.appendChild(toggleBtn);
                    }
                    
                    sourcesDiv.appendChild(sourcesHeader);
                    
                    const sourcesContainer = document.createElement('div');
                    sourcesContainer.className = 'sources-container';
                    
                    sources.forEach((source, index) => {
                        const sourceItem = document.createElement('div');
                        sourceItem.className = 'source-item';
                        
                        // Format the source display
                        const sectionText = source.section || 'Document';
                        const pagesText = source.pages || 'Unknown';
                        const confidenceText = source.relevance ? calculateConfidenceLevel(source.relevance) : 
                                             source.similarity_score ? calculateConfidenceLevel(source.similarity_score) : 'N/A';
                        
                        sourceItem.innerHTML = `🔗 ${sectionText} - Pages ${pagesText} (${confidenceText})`;
                        
                        // Hide sources beyond the limit initially
                        if (hasManySources && index >= maxVisibleSources) {
                            sourceItem.style.display = 'none';
                            sourceItem.classList.add('hidden-source');
                        }
                        
                        // Make source clickable to navigate to page
                        if (source.pages) {
                            sourceItem.style.cursor = 'pointer';
                            sourceItem.addEventListener('click', () => {
                                // Handle page ranges like "1608-1608" or "1614-1615"
                                const pageMatch = source.pages.match(/(\d+)/);
                                if (pageMatch) {
                                    const pageNumber = parseInt(pageMatch[1]);
                                    console.log(`🔗 Navigating to page ${pageNumber} from source: ${sectionText}`);
                                    navigateToPDFPage(pageNumber);
                                }
                            });
                        }
                        
                        sourcesContainer.appendChild(sourceItem);
                    });
                    
                    // Add toggle functionality for large source lists
                    if (hasManySources) {
                        const toggleBtn = sourcesHeader.querySelector('.sources-toggle-btn');
                        let isExpanded = false;
                        
                        toggleBtn.addEventListener('click', () => {
                            const hiddenSources = sourcesContainer.querySelectorAll('.hidden-source');
                            
                            if (isExpanded) {
                                // Collapse
                                hiddenSources.forEach(item => item.style.display = 'none');
                                toggleBtn.textContent = 'Show all';
                                isExpanded = false;
                            } else {
                                // Expand
                                hiddenSources.forEach(item => item.style.display = 'block');
                                toggleBtn.textContent = 'Show less';
                                isExpanded = true;
                            }
                        });
                    }
                    
                    sourcesDiv.appendChild(sourcesContainer);
                    messageContent.appendChild(sourcesDiv);
                }
            }
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                AI is thinking
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function clearChatHistory() {
            if (confirm('Are you sure you want to clear the conversation?')) {
                chatHistory = [];
                conversationId = generateConversationId();
                
                // Clear chat messages except welcome
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="welcome-message">
                        <div class="bot-message">
                            <div class="message-content">
                                <strong>🤖 AI Assistant</strong><br>
                                Hello! I'm your AI assistant. I can help you explore the ICC judgment document and answer questions about it. What would you like to know?
                            </div>
                        </div>
                    </div>
                `;
                
                // Add sample questions
                addSampleQuestions();
            }
        }

        function addSampleQuestions() {
            const chatMessages = document.getElementById('chatMessages');
            
            // Check if sample questions already exist
            if (chatMessages.querySelector('.sample-questions')) {
                return;
            }
            
            // Only add if we just have the welcome message (no conversation started)
            const messageCount = chatMessages.querySelectorAll('.user-message, .bot-message:not(.welcome-message .bot-message)').length;
            if (messageCount > 0) {
                return;
            }
            
            const sampleQuestions = [
                "What role did Alfred Yekatom play in the Anti-Balaka forces?",
                "What evidence was presented about persecution of Muslims?",
                "What were the main findings regarding war crimes?",
                "Tell me about the court's verdict on crimes against humanity",
                "What was the timeline of events in the Central African Republic?",
                "How did the court evaluate witness testimonies?"
            ];
            
            const sampleQuestionsDiv = document.createElement('div');
            sampleQuestionsDiv.className = 'sample-questions';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'sample-questions-title';
            titleDiv.textContent = 'Try these sample questions:';
            sampleQuestionsDiv.appendChild(titleDiv);
            
            sampleQuestions.forEach(question => {
                const questionButton = document.createElement('button');
                questionButton.className = 'sample-question-item';
                questionButton.textContent = question;
                questionButton.addEventListener('click', () => {
                    // Fill the input with the question
                    const chatInput = document.getElementById('chatInput');
                    chatInput.value = question;
                    chatInput.focus();
                    
                    // Auto-resize the textarea
                    chatInput.style.height = 'auto';
                    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                });
                sampleQuestionsDiv.appendChild(questionButton);
            });
            
            chatMessages.appendChild(sampleQuestionsDiv);
            
            // Scroll to show the sample questions
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>